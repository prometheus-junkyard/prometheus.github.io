<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Prometheus monitoring system and time series database">
    <meta name="keywords" content="prometheus, monitoring, monitoring system, time series, time series database, alerting, metrics, telemetry">
    <meta name="author" content="Prometheus">

    <link rel="alternate" type="application/atom+xml" title="Prometheus Blog Â» Feed" href="/blog/feed.xml">

    <link rel="shortcut icon" href="/assets/favicons/favicon.ico">
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/assets/favicons/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/assets/favicons/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/assets/favicons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/assets/favicons/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/assets/favicons/android-chrome-manifest.json">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-TileImage" content="/assets/favicons/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    
    <title>Storage | Prometheus</title>
    

    <!-- Bootstrap core CSS -->
    <link href="/assets/bootstrap-3.3.1/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/assets/docs.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/assets/font-awesome-4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/"><img src="/assets/prometheus_logo_grey.svg" alt="Prometheus logo"> Prometheus</a>
        </div>
        <div class="collapse navbar-collapse" id="navbar">
          <ul class="nav navbar-nav navbar-right main-nav">
            <li><a href="/">Overview</a></li>
            <li><a href="/docs/introduction/overview/">Documentation</a></li>
            <li><a href="/community/">Community</a></li>
            <li><a href="/blog/">Blog</a></li>
            <li><a href="https://github.com/prometheus"><i class="fa fa-github"></i> Github</a></li>
          </ul>
        </div>
      </div>
    </nav>


<div class="container">
  <div class="row">
    <div class="col-md-3 side-nav-col">
      <ul class="nav navbar-nav side-nav">
        
          <li><span class="nav-header"><i class="fa fa-hand-o-right"></i> Introduction</span><ul class="nav"><li><a href="/docs/introduction/overview/">Overview</a></li><li><a href="/docs/introduction/install/">Installing</a></li><li><a href="/docs/introduction/getting_started/">Getting started</a></li><li><a href="/docs/introduction/comparison/">Comparison to alternatives</a></li><li><a href="/docs/introduction/faq/">FAQ</a></li><li><a href="/docs/introduction/roadmap/">Roadmap</a></li><li><a href="/docs/introduction/media/">Media</a></li><li><a href="/docs/introduction/glossary/">Glossary</a></li></ul></li>
        
          <li><span class="nav-header"><i class="fa fa-flask"></i> Concepts</span><ul class="nav"><li><a href="/docs/concepts/data_model/">Data model</a></li><li><a href="/docs/concepts/metric_types/">Metric types</a></li><li><a href="/docs/concepts/jobs_instances/">Jobs and instances</a></li></ul></li>
        
          <li><span class="nav-header"><i class="fa fa-search"></i> Querying</span><ul class="nav"><li><a href="/docs/querying/basics/">Basics</a></li><li><a href="/docs/querying/operators/">Operators</a></li><li><a href="/docs/querying/functions/">Functions</a></li><li><a href="/docs/querying/examples/">Examples</a></li><li><a href="/docs/querying/rules/">Recording rules</a></li><li><a href="/docs/querying/api/">HTTP API</a></li></ul></li>
        
          <li><span class="nav-header"><i class="fa fa-line-chart"></i> Visualization</span><ul class="nav"><li><a href="/docs/visualization/browser/">Expression browser</a></li><li><a href="/docs/visualization/promdash/">PromDash</a></li><li><a href="/docs/visualization/consoles/">Console templates</a></li><li><a href="/docs/visualization/template_examples/">Template examples</a></li><li><a href="/docs/visualization/template_reference/">Template reference</a></li><li><a href="/docs/visualization/grafana/">Grafana</a></li></ul></li>
        
          <li><span class="nav-header"><i class="fa fa-code"></i> Instrumenting</span><ul class="nav"><li><a href="/docs/instrumenting/clientlibs/">Client libraries</a></li><li><a href="/docs/instrumenting/pushing/">Pushing metrics</a></li><li><a href="/docs/instrumenting/exporters/">Exporters and third-party integrations</a></li><li><a href="/docs/instrumenting/exposition_formats/">Exposition formats</a></li></ul></li>
        
          <li><span class="nav-header"><i class="fa fa-cog"></i> Operating</span><ul class="nav"><li><a href="/docs/operating/configuration/">Configuration</a></li><li class="active"><a href="/docs/operating/storage/">Storage</a></li><li><a href="/docs/operating/federation/">Federation</a></li></ul></li>
        
          <li><span class="nav-header"><i class="fa fa-bell-o"></i> Alerting</span><ul class="nav"><li><a href="/docs/alerting/overview/">Alerting overview</a></li><li><a href="/docs/alerting/alertmanager/">Alertmanager</a></li><li><a href="/docs/alerting/rules/">Alerting rules</a></li></ul></li>
        
          <li><span class="nav-header"><i class="fa fa-thumbs-o-up"></i> Best practices</span><ul class="nav"><li><a href="/docs/practices/naming/">Metric and label naming</a></li><li><a href="/docs/practices/consoles/">Consoles and dashboards</a></li><li><a href="/docs/practices/instrumentation/">Instrumentation</a></li><li><a href="/docs/practices/histograms/">Histograms and summaries</a></li><li><a href="/docs/practices/alerting/">Alerting</a></li><li><a href="/docs/practices/rules/">Recording rules</a></li></ul></li>
        
      </ul>
    </div>

    <div class="col-md-9 doc-content">
      <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>
<h1 id="storage" class="page-header">Storage<a class="header-anchor" href="#storage" name="storage"></a>
</h1>
<div class="toc toc-right"><ul>
<li><a href="#memory-usage">Memory usage
</a></li>
<li><a href="#disk-usage">Disk usage
</a></li>
<li><a href="#settings-for-high-numbers-of-time-series">Settings for high numbers of time series
</a></li>
<li><a href="#crash-recovery">Crash recovery
</a></li>
<li><a href="#data-corruption">Data corruption
</a></li>
</ul></div>

<p>Prometheus has a sophisticated local storage subsystem. For indexes,
it uses <a href="https://github.com/google/leveldb">LevelDB</a>. For the bulk
sample data, it has its own custom storage layer, which organizes
sample data in chunks of constant size (1024 bytes payload). These
chunks are then stored on disk in one file per time series.</p>

<h2 id="memory-usage">Memory usage<a class="header-anchor" href="#memory-usage" name="memory-usage"></a>
</h2>

<p>Prometheus keeps all the currently used chunks in memory. In addition,
it keeps the most recently used chunks in memory up to a threshold
configurable via the <code>storage.local.memory-chunks</code> flag. If you have a
lot of RAM available, you might want to increase it above the default
value of 1048576 (and vice versa, if you run into RAM problems, you
can try to decrease it). Note that the actual RAM usage of your server
will be much higher than what you would expect from multiplying
<code>storage.local.memory-chunks</code> by 1024 bytes. There is inevitable
overhead for managing the sample data in the storage layer. Also, your
server is doing many more things than just storing samples. The actual
overhead depends on your usage pattern. In extreme cases, Prometheus
has to keep more chunks in memory than configured because all those
chunks are in use at the same time. You have to experiment a bit. The
metrics <code>prometheus_local_storage_memory_chunks</code> and
<code>process_resident_memory_bytes</code>, exported by the Prometheus server,
will come in handy. As a rule of thumb, you should have at least three
times more RAM available than needed by the memory chunks alone.</p>

<p>LevelDB is essentially dealing with data on disk and relies on the
disk caches of the operating system for optimal performance. However,
it maintains in-memory caches, whose size you can configure for each
index via the following flags:</p>

<ul>
<li><code>storage.local.index-cache-size.fingerprint-to-metric</code></li>
<li><code>storage.local.index-cache-size.fingerprint-to-timerange</code></li>
<li><code>storage.local.index-cache-size.label-name-to-label-values</code></li>
<li><code>storage.local.index-cache-size.label-pair-to-fingerprints</code></li>
</ul>

<h2 id="disk-usage">Disk usage<a class="header-anchor" href="#disk-usage" name="disk-usage"></a>
</h2>

<p>Prometheus stores its on-disk time series data under the directory
specified by the flag <code>storage.local.path</code>. The default path is
<code>./data</code>, which is good to try something out quickly but most
likely not what you want for actual operations. The flag
<code>storage.local.retention</code> allows you to configure the retention time
for samples. Adjust it to your needs and your available disk space.</p>

<h2 id="settings-for-high-numbers-of-time-series">Settings for high numbers of time series<a class="header-anchor" href="#settings-for-high-numbers-of-time-series" name="settings-for-high-numbers-of-time-series"></a>
</h2>

<p>Prometheus can handle millions of time series. However, you have to
adjust the storage settings for that. Essentially, you want to allow a
certain number of chunks for each time series to be kept in RAM. The
default value for the <code>storage.local.memory-chunks</code> flag (discussed
above) is 1048576. Up to about 300,000 series, you still have three
chunks available per series on average. For more series, you should
increase the <code>storage.local.memory-chunks</code> value. Three times the
number of series is a good first approximation. But keep the
implication for memory usage (see above) in mind.</p>

<p>Even more important is raising the value for the
<code>storage.local.max-chunks-to-persist</code> flag at the same time. As a rule
of thumb, keep it somewhere between 50% and 100% of the
<code>storage.local.memory-chunks</code> value. The main drawback of a high value
is larger checkpoints. The consequences of a value too low are much
more serious.</p>

<p>Out of the metrics that Prometheus exposes about itself, the following are
particularly useful for tuning the flags above:</p>

<ul>
<li>
<code>prometheus_local_storage_memory_series</code>: The current number of series held in memory.</li>
<li>
<code>prometheus_local_storage_memory_chunks</code>: The current number of chunks held in memory.</li>
<li>
<code>prometheus_local_storage_chunks_to_persist</code>: The number of memory chunks that still need to be persisted to disk.</li>
</ul>

<p>PromQL queries that involve a high number of time series will make heavy use of
the LevelDB backed indices. If you need to run queries of that kind, tweaking
the index cache sizes might be required. The following flags are relevant:</p>

<ul>
<li>
<code>-storage.local.index-cache-size.label-name-to-label-values</code>: For regular
expression matching.</li>
<li>
<code>-storage.local.index-cache-size.label-pair-to-fingerprints</code>: Increase the
size if a large number of time series share the same label pair or name.</li>
<li>
<code>-storage.local.index-cache-size.fingerprint-to-metric</code> and
<code>-storage.local.index-cache-size.fingerprint-to-timerange</code>: Increase the size
if you have a large number of archived time series, i.e. series that have not
received samples in a while but are still not old enough to be purged
completely.</li>
</ul>

<p>You have to experiment with the flag values to find out what helps. If a query
touches 100,000+ time series, hundreds of MiB might be reasonable.</p>

<h2 id="crash-recovery">Crash recovery<a class="header-anchor" href="#crash-recovery" name="crash-recovery"></a>
</h2>

<p>Prometheus saves chunks to disk as soon as possible after they are
complete. Incomplete chunks are saved to disk during regular
checkpoints. You can configure the checkpoint interval with the flag
<code>storage.local.checkpoint-interval</code>. Prometheus creates checkpoints
more frequently than that if too many time series are in a "dirty"
state, i.e. their current incomplete head chunk is not the one that is
contained in the most recent checkpoint. This limit is configurable
via the <code>storage.local.checkpoint-dirty-series-limit</code> flag.</p>

<p>Nevertheless, should your server crash, you might still lose data, and
your storage might be left in an inconsistent state. Therefore,
Prometheus performs a crash recovery after an unclean shutdown,
similar to an <code>fsck</code> run for a file system. Details about the crash
recovery are logged, so you can use it for forensics if required. Data
that cannot be recovered is moved to a directory called <code>orphaned</code>
(located under <code>storage.local.path</code>). Remember to delete that data if
you do not need it anymore.</p>

<p>The crash recovery usually takes less than a minute. Should it take much
longer, consult the log to find out what has gone wrong.</p>

<h2 id="data-corruption">Data corruption<a class="header-anchor" href="#data-corruption" name="data-corruption"></a>
</h2>

<p>If you suspect problems caused by corruption in the database, you can
enforce a crash recovery by starting the server with the flag
<code>storage.local.dirty</code>.</p>

<p>If that does not help, or if you simply want to erase the existing
database, you can easily start fresh by deleting the contents of the
storage directory:</p>

<ol>
<li>Stop Prometheus.</li>
<li><code>rm -r &lt;storage path&gt;/*</code></li>
<li>Start Prometheus.</li>
</ol>
</body></html>

    </div>

  </div>
  <hr>

<footer>
  <p class="pull-left">
    &copy; Prometheus Authors 2015
  </p>
</footer>

</div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/assets/bootstrap-3.3.1/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="/assets/ie10-viewport-bug-workaround.js"></script>
    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58468480-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>

